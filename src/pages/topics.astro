---
import BaseLayout from '../layouts/BaseLayout.astro';
import QuestionCard from '../components/QuestionCard.vue';
import SearchBar from '../components/SearchBar.vue';
import TopicFilter from '../components/TopicFilter.vue';
import { getCollection, type CollectionEntry } from 'astro:content';

const allQuestions = await getCollection('questions');
const sortedQuestions = allQuestions.sort((a: CollectionEntry<'questions'>, b: CollectionEntry<'questions'>) => a.data.order - b.data.order);

const categories = [...new Set(allQuestions.map((q: CollectionEntry<'questions'>) => q.data.category))] as string[];
const difficulties = ['easy', 'medium', 'hard'];

const questionsByCategory = categories.reduce((acc, category) => {
  acc[category] = sortedQuestions.filter((q: CollectionEntry<'questions'>) => q.data.category === category);
  return acc;
}, {} as Record<string, CollectionEntry<'questions'>[]>);

// –ü–µ—Ä–µ–¥–∞—ë–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
const questionsData = sortedQuestions.map(q => ({
  slug: q.slug,
  title: q.data.title,
  description: q.data.description,
  category: q.data.category,
  difficulty: q.data.difficulty,
  tags: q.data.tags
}));
---

<BaseLayout title="–í—Å–µ —Ç–µ–º—ã - JS Interview Prep">
  <div class="container mx-auto px-4 py-12 max-w-6xl">
    <div class="mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-6 bg-gradient-to-r from-primary-400 to-primary-600 bg-clip-text text-transparent">
        –í—Å–µ —Ç–µ–º—ã
      </h1>
      <p class="text-xl text-gray-400 mb-8">
        –ò–∑—É—á–∞–π—Ç–µ JavaScript –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏ —É—Ä–æ–≤–Ω—è–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
      </p>
      <SearchBar client:load />
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <TopicFilter 
      client:load 
      categories={categories}
      difficulties={difficulties}
    />

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ -->
    <div id="questions-container">
      {categories.map((category: string) => (
        <section 
          id={category.toLowerCase().replace(/\s+/g, '-')} 
          class="mb-16 category-section"
          data-category={category}
        >
          <div class="flex items-center mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-100">
              {category}
            </h2>
            <span class="ml-4 px-3 py-1 bg-primary-500/20 text-primary-400 rounded-full text-sm font-medium border border-primary-500/30 category-count">
              {questionsByCategory[category].length}
            </span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 questions-grid">
            {questionsByCategory[category].map((question: CollectionEntry<'questions'>) => (
              <div 
                class="question-item"
                data-category={question.data.category}
                data-difficulty={question.data.difficulty}
              >
                <QuestionCard
                  client:visible
                  title={question.data.title}
                  description={question.data.description}
                  url={`/questions/${question.slug}.html`}
                  difficulty={question.data.difficulty}
                  tags={question.data.tags}
                />
              </div>
            ))}
          </div>
        </section>
      ))}
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <div id="no-results" class="hidden text-center py-16">
      <div class="text-6xl mb-4">üîç</div>
      <h3 class="text-2xl font-bold text-gray-300 mb-2">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
      <p class="text-gray-400">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
    </div>
  </div>
</BaseLayout>

<script>
  // Client-side filtering functionality
  let currentFilters = {
    category: null as string | null,
    difficulty: null as string | null,
    search: ''
  };

  function applyFilters() {
    const questionItems = document.querySelectorAll('.question-item');
    const categorySections = document.querySelectorAll('.category-section');
    const noResults = document.getElementById('no-results');
    let visibleCount = 0;

    // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏ —Å–Ω–∞—á–∞–ª–∞
    categorySections.forEach(section => {
      (section as HTMLElement).style.display = 'none';
    });

    questionItems.forEach((item) => {
      const category = item.getAttribute('data-category');
      const difficulty = item.getAttribute('data-difficulty');
      const title = item.querySelector('h3')?.textContent?.toLowerCase() || '';
      const description = item.querySelector('p')?.textContent?.toLowerCase() || '';

      let visible = true;

      // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      if (currentFilters.category && category !== currentFilters.category) {
        visible = false;
      }

      // –§–∏–ª—å—Ç—Ä –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
      if (currentFilters.difficulty && difficulty !== currentFilters.difficulty) {
        visible = false;
      }

      // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
      if (currentFilters.search) {
        const searchLower = currentFilters.search.toLowerCase();
        if (!title.includes(searchLower) && !description.includes(searchLower)) {
          visible = false;
        }
      }

      (item as HTMLElement).style.display = visible ? '' : 'none';
      if (visible) {
        visibleCount++;
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —Å–µ–∫—Ü–∏—é
        const parentSection = item.closest('.category-section');
        if (parentSection) {
          (parentSection as HTMLElement).style.display = '';
        }
      }
    });

    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    categorySections.forEach(section => {
      const visibleItems = section.querySelectorAll('.question-item:not([style*="display: none"])');
      const countElement = section.querySelector('.category-count');
      if (countElement) {
        countElement.textContent = visibleItems.length.toString();
      }
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
    if (noResults) {
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }

  // –°–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  document.addEventListener('DOMContentLoaded', () => {
    // –ü–æ–∏—Å–∫
    const searchBar = document.querySelector('input[type="text"]');
    if (searchBar) {
      searchBar.addEventListener('input', (e) => {
        currentFilters.search = (e.target as HTMLInputElement).value;
        applyFilters();
      });
    }

    // –§–∏–ª—å—Ç—Ä—ã (—á–µ—Ä–µ–∑ custom event –æ—Ç Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞)
    window.addEventListener('topic-filter', ((e: CustomEvent) => {
      currentFilters.category = e.detail.category;
      currentFilters.difficulty = e.detail.difficulty;
      applyFilters();
    }) as EventListener);
  });
</script>
